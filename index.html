<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Push Notification Sample</title>
  <link rel="manifest" href="/manifest.json">
</head>
<body>

  <button id="push-button" disabled>Subscribe</button>

  <form action="#">
    <div>
      <input id="input-title" type="text">
      <label for="input-title">Post Title</label>
    </div>

    <button type="submit" id="add-post">Add Post</button>
  </form>

  <script src="//www.gstatic.com/firebasejs/4.3.0/firebase.js"></script>
  <script>
    // Initialize Firebase
    var config = {
      apiKey: "AIzaSyC7W0Fgf3Sf2XXR3GLxLy1MLVFADG-7ml8",
      authDomain: "push-notifications-sampl-39a33.firebaseapp.com",
      databaseURL: "https://push-notifications-sampl-39a33.firebaseio.com",
      projectId: "push-notifications-sampl-39a33",
      storageBucket: "push-notifications-sampl-39a33.appspot.com",
      messagingSenderId: "979896802364"
    };
    firebase.initializeApp(config);


    const messaging = firebase.messaging(),
      database  = firebase.database(),
      pushBtn   = document.getElementById('push-button')

    let userToken    = null,
        isSubscribed = false

    window.addEventListener('load', () => {
      if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('./service-worker.js')
          .then(registration => {
            messaging.useServiceWorker(registration)
            initializePush()
          })
          .catch(err => console.log('Service Worker Error', err))
      } else {
        pushBtn.textContent = 'Push not supported.'
      }
    })

    function initializePush() {
      userToken = localStorage.getItem('pushToken')
      isSubscribed = userToken !== null
      updateBtn()

      pushBtn.addEventListener('click', () => {
        pushBtn.disabled = true
        if (isSubscribed) return unsubscribeUser()
        return subscribeUser()
      })
    }

    function updateBtn() {
      if (Notification.permission === 'denied') {
        pushBtn.textContent = 'Subscription blocked'
        return
      }
      pushBtn.textContent = isSubscribed ? 'Unsubscribe' : 'Subscribe'
      pushBtn.disabled = false
    }

    function subscribeUser() {
      messaging.requestPermission()
        .then(() => messaging.getToken())
        .then(token => {
          updateSubscriptionOnServer(token)
          isSubscribed = true
          userToken = token
          localStorage.setItem('pushToken', token)
          updateBtn()
        })
        .catch(err => console.log('Denied', err))
    }

    function updateSubscriptionOnServer(token) {
      if (isSubscribed) {
        return database.ref('device_ids')
          .equalTo(token)
          .on('child_added', snapshot => snapshot.ref.remove())
      }

      database.ref('device_ids').once('value')
        .then(snapshots => {
          let deviceExists = false
          snapshots.forEach(childSnapshot => {
            if (childSnapshot.val() === token) {
              deviceExists = true
              return console.log('Device already registered.');
            }
          })

          if (!deviceExists) {
            console.log('Device subscribed');
            return database.ref('device_ids').push(token)
          }
      })
    }

    function unsubscribeUser() {
      messaging.deleteToken(userToken)
        .then(() => {
          updateSubscriptionOnServer(userToken)
          isSubscribed = false
          userToken = null
          localStorage.removeItem('pushToken')
          updateBtn()
        })
        .catch(err => console.log('Error unsubscribing', err))
    }
  </script>
</body>
</html>
